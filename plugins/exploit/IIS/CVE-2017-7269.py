# -*-* coding:UTF-8
import socket


class Plugin(Base):
    __info__ = {
        "name": "iis6.0远程代码执行漏洞",
        "description": "IIS 6.0开启Webdav服务的服务器被爆存在缓存区溢出漏洞导致远程代码随意执行，目前针对 Windows Server 2003 R2 可以稳定利用",
        "references": ["-"],
    }

    def __condition__(self):
        return self.condition(
            matches=[
                {
                    "search": "headers",
                    "keyword": "Microsoft-IIS"
                },
                {
                    "search": "headers",
                    "keyword": "IIS/"
                },
                {
                    "search": "headers",
                    "keyword": "iis/"
                }
            ]
        )

    def url(self) -> dict:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(5)
            s.connect((self.target.ip, self.target.port))
            s.send(b"OPTIONS / HTTP/1.0\r\n\r\n")
            data = s.recv(2048).decode()
            if "PROPFIND" in data and "Microsoft-IIS/6.0" in data:
                return {"LoopholeInfo": self.__info__}
